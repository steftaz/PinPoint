{% extends "datacaptureapp/base.html" %}

<!--
    This code displays an overview of the project data by displaying a Leaflet map which shows all the previously recorded points an some general data about the project.
 !-->

{% block content %}

    <h3 id="helpIcon" tabindex="0" class="pull-right" data-toggle="popover" style="margin-left:5px"
        data-placement="left" data-trigger=focus" aria-hidden=true" data-html="true"
        title="Project page"
        data-content="<b> Map </b> <br>
        The map in the middle of the page shows all the points that are collected for the project and the red dot visualises your current location.
        <br>
        <br>
        <b> Add Data </b> <br>
        To add a data point click the button 'Record data point'.
        <br>
        <br>
        <b> View Data </b> <br>
        To see an overview of all the data collected click the button 'Data overview'.
        <br>
        <br>
         <b> Project Team </b> <br>
        To see an overview of all the contributors of the project click 'Project team'.
        <br>
        <br>
        <b> Project info </b> <br>
        Below the section 'About' you can see the Id, Name, description and owner of the project.
            ">
        <span class="fa fa-question-circle" style="color:grey; margin-right:10px"></span>
    </h3>
    <br>

    <h1 class="text-center" style="font-size:min(5vw, 50px);font-family:'Calibri'">{{project.name}}</h1>


    <div class="container">
        <hr/>
        <div class="row-justify-content-center">
            <div class="col lg auto">
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"

                      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
                      crossorigin=""/>
                <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
                        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
                        crossorigin=""></script>

                <div id="map" style="height:450px">
                </div>
                <br>
            </div>
            <div class="text-center" id="div_messages">
            </div>
            <div class ="text-center">
                <button id="join-public-project" onclick="joinPublicProject()" class="text-center btn btn-success btn-lg mb-1"  type="button"><i class="fa fa-plus"> </i> Add to your projects</button>
                <button onclick="location.href='nodes/new'" class="text-center btn btn-info btn-lg mb-1"  type="button"><i class="fa fa-plus"> </i> Record data point</button>
                <button onclick="location.href='nodes'" class="text-center btn btn-info btn-lg mb-1"  type="button"><i class="fa fa-table"></i> Data overview</button>
                {% if is_owner %}
                    <button onclick="location.href='team'" class="text-center btn btn-info btn-lg mb-1"  type="button"><i class="fa fa-group"></i> Project team </button>
                    <button onclick="location.href='edit'" class="text-center btn btn-info btn-lg mb-1"  type="button"><i class="fa fa-pencil-square-o"></i> Edit project </button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row sm">
            <div class="col sm auto">
                <br>
                <h1 class="text-center" style="font-size:min(5vw, 50px);font-family:'Calibri'"> About </h1>
            </div>

        </div>
        <div class="row-justify-content-center">
            <div class="col sm auto">
                <table class="table table-center table-unbordered  text-muted">
                    <tbody>
                    <tr>
                        <th scope="row">ID</th>
                        <td>{{project.id}}</td>
                    </tr>
                    <tr>
                        <th scope="row">Name</th>
                        <td>{{project.name}}</td>

                    </tr>
                    <tr>
                        <th scope="row">Description</th>
                        <td> {{project.description}}</td>

                    </tr>

                    <tr>
                        <th scope="row">Owner</th>
                        <td>{{project.owner.username}}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>

        // Hide the add public project to your projects button if the user is already a member or the project is not public
        const canJoin = '' + '{{ can_join }}';
        if (canJoin !== 'True') {
            $('#join-public-project').hide()
        }

        // LEAFLET script:


        let map = L.map('map').fitWorld();
        let positionMarker;

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 20,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
        }).addTo(map);

        function onLocationFound(e) {
            if (positionMarker == null) {
                positionMarker = L.circleMarker(e.latlng, {radius: 7, color: '#FFFFFF', fillOpacity: 1, fillColor: '#FF0000', opacity: 0.5})
                    .addTo(map).bindPopup("You are here");
            } else {
                positionMarker.setLatLng(e.latlng);
            }
        }

        function onLocationError(e) {
            alert(e.message);
        }


        map.on('locationfound', onLocationFound);

        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties["Test text"]) {
                layer.bindPopup(feature.properties["Test text"]);
            }
        }

        function locate() {
            map.locate({setView: false, enableHighAccuracy: true});
        }

        // call locate every 3 seconds... forever
        setInterval(locate, 1000);

        {% for key, value in overview.items %}
            var marker = L.marker([{{ value.latitude}}, {{ value.longitude}}]).addTo(map);

            marker.bindPopup('<table class="table table-stripped" >'+
                '<thead>'+
                '<tr>'+
                '<th scope="col"><b>Latitude</b></th>' +
                '<th scope="col"><b>Longitude </b></th>' +
                '{% for attribute in attributes %}'+
                    '<th scope="col"> <b>{{ attribute.name }}</b></th>'+
                    '{% endfor %}'+
                '</tr>'+
                '</thead>'+
                '<tbody>'+
                '<tr>'+
                '{% for data in value.values %}'+
                    '<td > <b>{{ data }}</b></td>'+
                    '{% endfor %}'+
                '</tr>'+
                '</tbody>'+
                '</table>');
        {% endfor %}

        map.locate({setView: true, maxZoom: 16});


        function joinPublicProject() {
            $.ajax({
                type: "POST",
                url: "{% url 'project' project.id %}",
                headers: {"X-CSRFToken": "{{csrf_token}}"},
                data: '',
                success: function (response) {
                    $("#div_messages").append("<div class='alert alert-success' role='alert'>" + response.messages[0]['message'] + "</div>");
                    $("#join-public-project").hide()
                }

            });
        }

    </script>

{% endblock %}