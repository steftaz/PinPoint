{% extends "datacaptureapp/base.html" %}

<!--
    This code displays an overview of the project data by displaying a Leaflet map which shows all the previously recorded points an some general data about the project.
 !-->

{% block content %}

    <h3 id="helpIcon" tabindex="0" class="pull-right" data-toggle="popover" style="margin-left:5px"
        data-placement="left" data-trigger=focus" aria-hidden=true" data-html="true"
        title="Project page"
        data-content="<b> Map </b> <br>
        The map in the middle of the page shows all the points that are collected for the project and the red dot visualises your current location.
        <br>
        <br>
        <b> Add Data </b> <br>
        To add a data point click the button 'Record data point'.
        <br>
        <br>
        <b> View Data </b> <br>
        To see an overview of all the data collected click the button 'Data overview'.
        <br>
        <br>
         <b> Project Team </b> <br>
        To see an overview of all the contributors of the project click 'Project team'.
        <br>
        <br>
        <b> Project info </b> <br>
        Below the section 'About' you can see the Id, Name, description and owner of the project.
            ">
        <span class="fa fa-question-circle" style="color:grey; margin-right:10px"></span>
    </h3>
    <br>

    <h1 class="text-center" style="font-size:min(5vw, 50px);font-family:'Calibri'">{{project.name}}</h1>
    <hr/>


    <div class="container">
        <div class="row-justify-content-center">
            <div class="col lg auto">
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"

                      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
                      crossorigin=""/>
                <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
                        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
                        crossorigin=""></script>

                <div id="map" style="height:450px">
                </div>
                <br>
            </div>
            <div class="text-center" id="div_messages">
            </div>
            <div class ="text-center">
                <button id="join-public-project" onclick="joinPublicProject()" class="text-center btn btn-success btn-lg"  type="button"><i class="fa fa-plus"> </i>Add this public project to your projects</button>
                <button onclick="location.href='nodes/new'" class="text-center btn btn-info btn-lg mb-1"  type="button"><i class="fa fa-plus"> </i> Record data point</button>
                <button onclick="location.href='nodes'" class="text-center btn btn-info btn-lg mb-1"  type="button"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-table" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm4 4H6v3h4V8z"/>
</svg> Data overview</button>
                <button id="team-button" onclick="location.href='team'" class="text-center btn btn-info btn-lg mb-1"  type="button"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-people" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8zm-7.978-1h7.956a.274.274 0 0 0 .014-.002l.008-.002c-.002-.264-.167-1.03-.76-1.72C13.688 10.629 12.718 10 11 10c-1.717 0-2.687.63-3.24 1.276-.593.69-.759 1.457-.76 1.72a1.05 1.05 0 0 0 .022.004zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0zM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816zM4.92 10c-1.668.02-2.615.64-3.16 1.276C1.163 11.97 1 12.739 1 13h3c0-1.045.323-2.086.92-3zM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
                </svg>Project team </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row sm">
            <div class="col sm auto">
                <br>
                <h1 class="text-center" style="font-size:min(5vw, 50px);font-family:'Calibri'"> About </h1>
            </div>

        </div>
        <div class="row-justify-content-center">
            <div class="col sm auto">
                <table class="table table-center table-unbordered  text-muted">
                    <tbody>
                    <tr>
                        <th scope="row">ID</th>
                        <td>{{project.id}}</td>
                    </tr>
                    <tr>
                        <th scope="row">Name</th>
                        <td>{{project.name}}</td>

                    </tr>
                    <tr>
                        <th scope="row">Description</th>
                        <td> {{project.description}}</td>

                    </tr>

                    <tr>
                        <th scope="row">Owner</th>
                        <td>{{project.owner.username}}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
    {#                {{ geojson|json_script:"geojson_map" }}#}

    <script>

    // Hide team button if the user is not the owner
        const user = '' + '{{ user.email }}';
        const owner = '' + '{{ project.owner.email }}';
        if (user != owner) {
            $('#team-button').hide()
        }

        // Hide the add public project to your projects button if the user is already a member or the project is not public
        const canJoin = '' + '{{ can_join }}';
        if (canJoin != 'True') {
            $('#join-public-project').hide()
        }

        // LEAFLET script:


        var map = L.map('map').fitWorld();

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 20,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
        }).addTo(map);

        function onLocationFound(e) {
            L.circleMarker(e.latlng, {radius: 7, color: '#FFFFFF', fillOpacity: 1, fillColor: '#FF0000', opacity: 0.5})
                .addTo(map).bindPopup("You are here");
        }

        function onLocationError(e) {
            alert(e.message);
        }


        map.on('locationfound', onLocationFound);

        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties["Test text"]) {
                layer.bindPopup(feature.properties["Test text"]);
            }
        }

     function locate() {
      map.locate({setView: false});
    }

    // call locate every 3 seconds... forever
    setInterval(locate, 3000);

        {% for key, value in overview.items %}

         var marker = L.marker([{{ value.latitude}}, {{ value.longitude}}]).addTo(map);

         marker.bindPopup('<table class="table table-stripped" >'+
         '<thead>'+
             '<tr>'+
             ' <th scope="col"><b>Latitude</b></th>\n' +
             '                    <th scope="col"><b>Longitude </b></th>\n' +
             '                    {% for attribute in attributes %}\n'+
                 '                        <th scope="col"> <b>{{ attribute.name }}</b></th>\n'+
                 '                    {% endfor %}'+
         '</tr>'+
         '</thead>'+
         '<tbody>'+
         '<tr>'+
         '{% for data in value.values %}'+
         '<td > <b>{{ data }}</b></td>'+
             '{% endfor %}'+
         '</tr>'+
         '</tbody>'+
         '</table>');


        {% endfor %}

        map.locate({setView: true, maxZoom: 16});


        //Location to put in DB script:

        var x = document.getElementById("demo");

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function showPosition(position) {
            x.innerHTML = "Latitude: " + position.coords.latitude +
                "<br>Longitude: " + position.coords.longitude;
        }


        function joinPublicProject() {
            $.ajax({
                type: "POST",
                url: "{% url 'project' project.id %}",
                headers: {"X-CSRFToken": "{{csrf_token}}"},
                data: '',
                success: function (response) {
                    $("#div_messages").append("<div class='alert alert-success' role='alert'>" + response.messages[0]['message'] + "</div>");
                    $("#join-public-project").hide()
                }

            });
        }

    </script>

{% endblock %}