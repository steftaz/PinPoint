{% extends "datacaptureapp/base.html" %}

{% block content %}
    <h3 id="helpIcon" tabindex="0" class="pull-right" data-toggle="popover" style="margin-left:5px"
        data-placement="left" data-trigger=focus" aria-hidden=true" data-html="true"
        title="Adding Data"
        data-content="<b> Add a data point</b> <br>
        Fill in the form you have defined by and click 'Store data point' to save this point. The location of this point will automatically be stored together with its features.
        <br>">
        <span class="fa fa-question-circle" style="color:grey; margin-right:10px"></span>
    </h3>
    <br>
    <h1 class="text-center" style="font-size:min(5vw, 50px); font-family:'Calibri'">Add Data</h1>
    <hr/>
    <br>

    <div class="form-group">


        <div class="container center_div">
            <form method="POST" id="storeDataPoint" enctype="multipart/form-data">


                <div class="form-group">
                    {% csrf_token %}
                    <div class="container center_div">
                        {% for data in datas %}
                            <br/>

                            <label for="name">{{ data.attribute.name }}</label>
                            <input type="{{ data.attribute.type }}" name="{{ data.attribute.name }}"
                                   class="form-control"
                                   placeholder="{{ data.attribute.name }}" id="{{ data.attribute.name }} required ">
                        {% endfor %}
                        <br>
                        <br>
                        <div class="custom-file">
                            {{ node_form }}
                            <button type="button" id="picture-button" class="btn btn-dark">
                                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-file-image"
                                     fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                          d="M4 0h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v10l2.224-2.224a.5.5 0 0 1 .61-.075L8 11l2.157-3.02a.5.5 0 0 1 .76-.063L13 10V2a1 1 0 0 0-1-1H4z"></path>
                                    <path fill-rule="evenodd" d="M6.502 7a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"></path>
                                </svg>
                                Picture
                            </button>
                            <span id="chosen-file">No picture chosen</span>
                        </div>
                        <br>
                        <br>
                        <button type="button" onclick="onSubmit()" class="btn btn-info">Store data point</button>
                        <a href="../../">
                            <button type="button" class="btn btn-outline-danger">Return to project</button>
                        </a>
                    </div>
                </div>
            </form>

        </div>
    </div>

    <script>
        $('#id_picture').attr({'hidden': 'hidden'});
        const pictureInput = document.getElementById("id_picture");
        const pictureButton = document.getElementById("picture-button");
        const chosenFile = document.getElementById("chosen-file");

        pictureButton.addEventListener("click", function () {
            pictureInput.click();
        });

        pictureInput.addEventListener("change", function () {
            if (pictureInput.value) {
                chosenFile.innerHTML = pictureInput.value.match(/[\/\\]([\w\d\s\.\-\(\)]+)$/)[1];
            } else {
                chosenFile.innerHTML = "No picture chosen";
            }
        });





        function onSubmit() {
            var iLat = document.getElementById('latitude');
            if (!iLat.value) {
                getLocation();
                return false;
            }
        }

        function recordPosition(position) {
            var iLat = document.getElementById('latitude');
            var iLong = document.getElementById('longitude');
            iLat.value = position.coords.latitude;
            iLong.value = position.coords.longitude;
            iLat.form.submit();
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getLocation_success, getLocation_error);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function getLocation_success(pos) {
            //showPosition(pos);
            recordPosition(pos);
        }

        function getLocation_error(err) {
            console.warn('ERROR(' + err.code + '): ' + err.message);
        }


    </script>

{% endblock %}